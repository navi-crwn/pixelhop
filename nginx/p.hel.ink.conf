# PicHost - p.hel.ink
# Nginx Configuration

server {
    listen 80;
    listen [::]:80;
    server_name p.hel.ink;
    
    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name p.hel.ink;

    # SSL Configuration (using same certificate as hel.ink)
    ssl_certificate /etc/ssl/certs/hel.ink.crt;
    ssl_certificate_key /etc/ssl/private/hel.ink.key;
    
    # SSL Security Settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;

    # Document Root
    root /var/www/pichost;
    index index.php index.html;

    # Logging
    access_log /var/log/nginx/p.hel.ink.access.log;
    error_log /var/log/nginx/p.hel.ink.error.log;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Client Upload Size
    client_max_body_size 15M;

    # Gzip Compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript;

    # Image proxy endpoint - /i/ (must be before static files)
    location ~ ^/i/ {
        fastcgi_pass unix:/var/run/php/php-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root/i.php;
        include fastcgi_params;
        fastcgi_read_timeout 60;
    }

    # Static files caching (exclude /i/)
    location ~* ^(?!/i/).*\.(css|js|ico|gif|jpeg|jpg|png|webp|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Tools page
    location = /tools {
        rewrite ^ /tools.php last;
    }

    # Result page (batch upload results) - use exact match
    location = /result {
        include fastcgi_params;
        fastcgi_pass unix:/var/run/php/php-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root/result.php;
        fastcgi_param QUERY_STRING $args;
    }

    # Individual tool shortcuts - redirect to tools with query param
    location = /compress {
        return 302 /tools?open=compress;
    }
    location = /resize {
        return 302 /tools?open=resize;
    }
    location = /crop {
        return 302 /tools?open=crop;
    }
    location = /convert {
        return 302 /tools?open=convert;
    }
    location = /ocr {
        return 302 /tools?open=ocr;
    }

    # API page (redirect /api and /api/ to /docs)
    location = /api {
        return 302 /docs;
    }
    location = /api/ {
        return 302 /docs;
    }

    # API Documentation
    location = /docs {
        rewrite ^ /docs.php last;
    }

    # Terms of Service
    location = /terms {
        rewrite ^ /terms.php last;
    }

    # Privacy Policy
    location = /privacy {
        rewrite ^ /privacy.php last;
    }

    # Help Center
    location = /help {
        rewrite ^ /help.php last;
    }

    # Contact page
    location = /contact {
        rewrite ^ /contact.php last;
    }

    # DMCA Policy
    location = /dmca {
        rewrite ^ /dmca.php last;
    }

    # Changelog
    location = /changelog {
        rewrite ^ /changelog.php last;
    }

    # Admin Dashboard
    location = /admin {
        rewrite ^ /admin.php last;
    }

    # Service Worker (no cache)
    location = /sw.js {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires 0;
        try_files $uri =404;
    }

    # PWA Manifest
    location = /manifest.json {
        add_header Cache-Control "public, max-age=86400";
        try_files $uri =404;
    }

    # Sitemap
    location = /sitemap.xml {
        add_header Content-Type "application/xml";
        try_files $uri =404;
    }

    # Robots.txt
    location = /robots.txt {
        add_header Content-Type "text/plain";
        try_files $uri =404;
    }

    # Main location - try static files first, then PHP routing
    location / {
        try_files $uri $uri/ @router;
    }

    # PHP router for short URLs
    location @router {
        rewrite ^/(.*)$ /view.php last;
    }

    # Error pages
    error_page 404 /404.php;
    error_page 500 502 503 504 /500.php;

    # API endpoint
    location /api/ {
        try_files $uri $uri/ /api/upload.php?$query_string;
    }

    # PHP Processing
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/var/run/php/php-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # Increase timeout for uploads
        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;
    }

    # Block access to sensitive files
    location ~ /\. {
        deny all;
    }

    location ~ ^/(config|data)/ {
        deny all;
    }

    # Block access to data directory but allow images.json for internal use
    location = /data/images.json {
        internal;
    }
}
